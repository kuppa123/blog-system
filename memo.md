# 設計メモ

## ファイル構成

### 方針

データベースで実装する場合、次のようなテーブル構成になる。

- 記事テーブル
    - 記事ID(PK)
    - ユーザID
    - カテゴリID
    - コンテンツ
- コメントテーブル
    - コメントID(PK)
    - 記事ID
    - ユーザID
    - コンテンツ
- カテゴリテーブル
    - カテゴリID(PK)
    - カテゴリ名    
- いいね！テーブル
    - 記事ID(PK)
    - ユーザID(PK)
- ユーザテーブル
    - ユーザID(PK)
    - パスワード

基本方針は以下の通り。

- 1テーブル：1ファイル
- 1レコード複数行で構成される場合は、1テーブル：1フォルダとし、フォルダ内に1レコードに相当するファイルを作成する

### ファイル構成

- 記事フォルダ
    - 記事ID1
    - 記事ID2
- コメントフォルダ
    - コメントID1
    - コメントID2
- カテゴリファイル
- いいね！ファイル
- ユーザファイル

## 設計検討

### 各ファイルの内容はメモリ上にキャッシュする

理由は以下の通り。目的は性能であり、メモリ上にキャッシュしなくても実装は可能。

- 検索処理をメモリ上で行う必要があり、毎回読み込むのは性能が悪いため
- CSVファイルの場合レコード単位の更新ができず、「全体読み込み⇒メモリ上で更新⇒全体をファイル出力」が必要になり、毎回読み込むのは効率が悪いため

### 記事ファイルにはカテゴリのIDのみ保持する

ArticleRepositoryにカテゴリを反映するメソッドを追加して呼び出す。

- ArticleRepositoryの初期化時
    - すべてのカテゴリを反映させるメソッドを用意し、ArticleRepositoryの初期化後に呼び出して反映させる
- カテゴリの変更時
    - カテゴリを渡して、そのカテゴリを持つ記事を更新する
- カテゴリの削除時
    - カテゴリのslugを渡して、そのカテゴリを持つ記事を更新し、更にファイルにも反映する

### フロントエンドからの情報取得

記事、コメント、いいねを取得する API をそれぞれ呼び出してもらう。

### マルチユーザ

#### 同時アクセス

同時アクセス対策の排他制御は考慮しないこととする。

#### 複数人の利用に対する考慮

複数人が同時にログインして操作可能だが、コンテンツの変更操作を行っている間に他のユーザによって変更操作に影響する操作が行われることはないこととする(基本仕様)。

例えば以下の操作を実行すると 3 でエラーが発生するが、このようなケースは基本仕様では考慮不要とする。

1. ユーザAがカテゴリCの更新画面を表示
2. ユーザBがカテゴリCを削除
3. ユーザAがカテゴリCを更新⇒カテゴリが存在しないためエラー発生

### エラーハンドリング

ステータスコードでエラーを通知する。

|ステータスコード|エラー理由|
|---|---|
|400|不正なリクエスト不正|
|401|認証エラー|
|500|サーバサイドの予期しないエラー|

#### 400

記事、カテゴリ、コメントの新規作成・編集において入力値が要件を満たさない

- 入力値が空
- 入力値が要件を満たさない（長さ、文字種）
- カテゴリ名が重複

#### 401

認証に失敗したか、認証トークンが有効でない

- ログイン時のパスワード認証失敗
- ログインで発行された認証トークンの有効期限が切れた後のアクセス
- 未ログイン状態で認証が必要な操作にアクセス

#### 500

サーバサイドのエラー全般

- バグ
- I/Oエラー
